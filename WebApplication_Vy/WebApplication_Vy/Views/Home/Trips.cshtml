@model WebApplication_Vy.Models.DTO.TripData.TripDTO

@{
    ViewBag.Title = "Trips";
}
<div class="row">
    <h2 class="display-4">Showing alternatives from @Html.Raw(@ViewBag.Model.Departure_Station) to @Html.Raw(@ViewBag.Model.Arrival_Station) </h2>
</div>

<script type="text/javascript">
    $(function () {
        var trip = @Html.Raw(Json.Encode(@ViewBag.Model));
        console.log(trip);
        $(".table").hide();



        var itineraries = "";
        trips = fetch("https://booking.cloud.nsb.no/api/itineraries/search",{
            "credentials": "omit", "headers": { "accept": "application/json", "content-type": "application/json", "sec-fetch-mode": "cors", "x-language": "no" },
            "referrer": "https://www.vy.no/bestill/velg-togavgang?from=" + trip.Departure_Station + "%20S&fromDisplayName=" + trip.Departure_Station + "%20S&fromType=train-station-name&to="+ trip.Arrival_Station +"&toDisplayName="+ trip.Arrival_Station +"&toType=train-station-name&departureDatetime=" + trip.Date + "%20" + trip.Time.split(":")[0] + "%3A" + trip.Time.split(":")[1] + "&petFree=false&pasCats=1&numPasCats=1",
            "referrerPolicy": "no-referrer-when-downgrade", "body": "{\"to\":\"" + trip.Arrival_Station + "\",\"from\":\"" + trip.Departure_Station + "\",\"time\":\"" + trip.Date + "T" + trip.Time + "\",\"limitResultsToSameDay\":true,\"language\":\"no\",\"passengers\":[{\"type\":\"ADULT\",\"customerNumber\":null,\"discount\":\"NONE\",\"extras\":[]}],\"priceNecessity\":\"REQUIRED\"}", "method": "POST", "mode": "cors"
        }).then(data => data.json()).then(data => {
            itineraries = data.itineraries;
            console.log(itineraries);
            $.each(itineraries, function (index, value) {
                console.log(value);

                var steps = value.legs;
                var changes = -1;
                for (var train of steps) {
                    if (train.transportType == "TRAIN") {
                        changes++;
                    }
                }

                var changesText;
                if (changes == 0) {
                    changesText = "Direct";
                } else if (changes == 1) {
                    changesText = "1 change";
                } else {
                    changesText = changes + " changes";
                }

                //$("#content").append("<tr  id=\"" + index + "\">\
                //    <td scope=\"row\" style=\"font-weight: bold;\"class=\"Travel_Diff\">" + value.departureScheduled.match("[0-9]{2}:[0-9]{2}") + " - " + value.arrivalScheduled.match("[0-9]{2}:[0-9]{2}") + "</td>\
                //    <td class=\"Duration\">" + value.duration.hours + " t " + value.duration.minutes + " min </td>\
                //    <td class=\"Train_Changes\">" + legs + "</td>\
                //    <td class=\"Price\">" + value.priceOptions[value.priceOptions.length - 1].amount + "</td>\
                //    <td><button class=\"chooseTicket\" type=\"submit\">Choose</button></td></tr>");

                $("#trips").append("<form action=\"@Url.Action("trips", "home")\" method=\"POST\">\
                    <div class=\"form-group row align-items-center\" >\
                        <div style=\"font-weight: bold;\" class=\"col\">\
                            <input type=\"text\" hidden name=\"Departure_Time\" value=" + value.departureScheduled.match("[0-9]{2}:[0-9]{2}") + ">"+ value.departureScheduled.match("[0-9]{2}:[0-9]{2}") +" <span> - </span>\
                            <input type=\"text\" hidden name=\"ArrivalTime_Time\" value=" + value.arrivalScheduled.match("[0-9]{2}:[0-9]{2}") + ">" + value.arrivalScheduled.match("[0-9]{2}:[0-9]{2}") + "\
                        </div>\
                        <div class=\"col\" ><input type=\"text\" hidden name=Duration value=" + value.duration.days + "h" + value.duration.hours + "t" + value.duration.minutes + "m>" + value.duration.days + "h" + value.duration.hours + "t" + value.duration.minutes + "</div>\
                        <div class=\"col\" ><input type=\"number\" hidden name=Changes value=" + changesText + ">" + changesText + "</div>\
                        <div class=\"col\" ><input type=\"number\" hidden name=Price value=" + value.priceOptions[value.priceOptions.length - 1].amount + ">" + value.priceOptions[value.priceOptions.length - 1].amount + " kr</div>\
                        <div class=\"col\"><button type=\"submit\" class=\"btn btn-success float-right\">Success</button></div>\
                    </div></form>");


                //$("#trips").append("<li class=\"list-group-item\">\
                //    <span style=\"font-weight: bold;\">" + value.departureScheduled.match("[0-9]{2}:[0-9]{2}") + " - " + value.arrivalScheduled.match("[0-9]{2}:[0-9]{2}") + "</span>\
                //    <span>" + value.duration.hours + " t " + value.duration.minutes + " min</span>\
                //</li>");
            });
            $("#loading").remove();
            $(".trips").show();
        });

        $("#content").on("click", "button", function () {
            id = $(this).parent().parent()[0].id
            console.log(id)
            var jsonin = {
                Departure_Station: "@Html.Raw(@ViewBag.Model.Departure_Station)",
                Arrival_Station: "@Html.Raw(@ViewBag.Model.Arrival_Station)",
                Departure_Time: itineraries[id].departureScheduled,
                Arrival_Time: itineraries[id].arrivalScheduled,
                Duration: itineraries[id].duration,
                Train_Changes: itineraries[id].legs.length - 2,
                Price: itineraries[id].priceOptions[itineraries[id].priceOptions.length-1].amount,
            };
            console.log(jsonin)

            $.ajax({
                url: "@Url.Action("trips", "home")",
                type: 'POST',
                data: JSON.stringify(jsonin),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    $("body").html(data);
                }
            });
        });

        //$(".table").mouseover().css('cursor', 'pointer');
        //$("h2").on("click", function () {
        //    $('tr').hide()
        //})
    });

</script>


<div id="loading" class="text-center">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<div id="trips">
</div>

<table class="table">
    <tbody id="content">
    </tbody>
</table>
